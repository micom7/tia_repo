// ==============================================================================
// FB_Test_ManualMechCmdHandler - Unit tests for FC_ManualMechCmdHandler
// ==============================================================================
// Version: 3.2 (updated for CMD_SET_FORCE)
// Date: 2026-01-20
// ==============================================================================

FUNCTION_BLOCK "FB_Test_ManualMechCmdHandler"
{ S7_Optimized_Access := 'TRUE' }

VAR_INPUT
    Run    : BOOL;   // TRUE = execute test
    CaseId : INT;    // test case number
END_VAR

VAR_OUTPUT
    Passed   : BOOL;
    Failed   : BOOL;
    FailMask : DWORD;
END_VAR

VAR
    slot : UINT;

    LocalManualGlobal : BOOL;

    Exp_ManualAllowed : BOOL;
    Exp_CurrentOwner  : USINT;
    Exp_CurrentStatus : UINT;

    Exp_AckCommit  : UDINT;
    Exp_AckOk      : BOOL;
    Exp_RejectCode : USINT;
    Exp_AckSlot    : UINT;

    Exp_OwnerCur   : USINT;
    Exp_OwnerCurId : UINT;
    Exp_Cmd        : USINT;
    Exp_CmdParam1  : INT;
    Exp_ForceCode  : INT;
    Exp_LastCmd    : USINT;
END_VAR

BEGIN
    Passed := FALSE;
    Failed := FALSE;
    FailMask := 0;

    IF NOT Run THEN
        RETURN;
    END_IF;

    slot := 5;
    LocalManualGlobal := FALSE;

    // ------------------------------------------------------------------
    // ARRANGE - baseline "healthy" state
    // ------------------------------------------------------------------
    "DB_Mechs".Mechs[slot].DeviceType := "TYPE_REDLER";
    "DB_Mechs".Mechs[slot].TypedIndex := 0;
    "DB_Mechs".Mechs[slot].Enable_OK := TRUE;
    "DB_Mechs".Mechs[slot].LocalManual := FALSE;
    "DB_Mechs".Mechs[slot].Cmd := "CMD_NONE";
    "DB_Mechs".Mechs[slot].CmdParam1 := 0;
    "DB_Mechs".Mechs[slot].Force_Code := 0;
    "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_NONE";
    "DB_Mechs".Mechs[slot].OwnerCurId := 0;
    "DB_Mechs".Mechs[slot].LastCmd := "CMD_NONE";
    "DB_Mechs".Mechs[slot].FLTCode := "FLT_NONE";
    "DB_Mechs".Mechs[slot].Status := "STS_IDLE";

    "DB_PlcScada_MailBox".Req.Slot := slot;
    "DB_PlcScada_MailBox".Req.Cmd := "CMD_NONE";
    "DB_PlcScada_MailBox".Req.Param1 := 0;
    "DB_PlcScada_MailBox".Req.ReleaseOwner := FALSE;
    "DB_PlcScada_MailBox".Req.Commit := 0;

    "DB_PlcScada_MailBox".Ack.AckCommit := 0;
    "DB_PlcScada_MailBox".Ack.AckOk := FALSE;
    "DB_PlcScada_MailBox".Ack.RejectCode := 0;
    "DB_PlcScada_MailBox".Ack.Slot := 0;

    Exp_ManualAllowed := TRUE;
    Exp_CurrentOwner := "DB_Mechs".Mechs[slot].OwnerCur;
    Exp_CurrentStatus := "DB_Mechs".Mechs[slot].Status;

    Exp_AckCommit := 0;
    Exp_AckOk := FALSE;
    Exp_RejectCode := 0;
    Exp_AckSlot := 0;

    Exp_OwnerCur := "DB_Mechs".Mechs[slot].OwnerCur;
    Exp_OwnerCurId := "DB_Mechs".Mechs[slot].OwnerCurId;
    Exp_Cmd := "DB_Mechs".Mechs[slot].Cmd;
    Exp_CmdParam1 := "DB_Mechs".Mechs[slot].CmdParam1;
    Exp_ForceCode := "DB_Mechs".Mechs[slot].Force_Code;
    Exp_LastCmd := "DB_Mechs".Mechs[slot].LastCmd;

    // ------------------------------------------------------------------
    // TEST CASES
    // ------------------------------------------------------------------
    CASE CaseId OF
        // ============================================================
        // GROUP A: ManualAllowed calculation
        // ============================================================
        
        // A1: Mapped OK + enabled -> ManualAllowed = TRUE
        1:
            ;// baseline case

        // A2: LocalManualGlobal = TRUE -> ManualAllowed = FALSE
        2:
            LocalManualGlobal := TRUE;
            Exp_ManualAllowed := FALSE;

        // A3: Slot not mapped -> ManualAllowed = FALSE
        3:
            "DB_Mechs".Mechs[slot].DeviceType := "TYPE_NONE";
            "DB_Mechs".Mechs[slot].TypedIndex := UINT#16#FFFF;
            Exp_ManualAllowed := FALSE;

        // ============================================================
        // GROUP B: Slot validation
        // ============================================================
        
        // B1: Slot > 255 -> Reject MAN_REJ_SLOT_UNMAPPED
        4:
            "DB_PlcScada_MailBox".Req.Slot := UINT#300;
            "DB_PlcScada_MailBox".Req.Commit := 1;

            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_SLOT_UNMAPPED";
            Exp_AckSlot := UINT#300;

        // B2: LocalManual slot -> Reject MAN_REJ_LOCAL_MANUAL
        5:
            "DB_Mechs".Mechs[slot].LocalManual := TRUE;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";
            "DB_PlcScada_MailBox".Req.Commit := 1;

            Exp_ManualAllowed := FALSE;
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_LOCAL_MANUAL";
            Exp_AckSlot := slot;

        // B3: Enable_OK = FALSE -> Reject MAN_REJ_NOT_ENABLED
        6:
            "DB_Mechs".Mechs[slot].Enable_OK := FALSE;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";
            "DB_PlcScada_MailBox".Req.Commit := 1;

            Exp_ManualAllowed := FALSE;
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_NOT_ENABLED";
            Exp_AckSlot := slot;

        // B4: Owner != NONE/SCADA -> Reject MAN_REJ_OWNER_BUSY
        7:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_ROUTE";
            "DB_Mechs".Mechs[slot].OwnerCurId := 2;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";
            "DB_PlcScada_MailBox".Req.Commit := 1;

            Exp_ManualAllowed := FALSE;
            Exp_CurrentOwner := "OWNER_ROUTE";
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_OWNER_BUSY";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_ROUTE";
            Exp_OwnerCurId := 2;

        // B5: Cmd = NONE -> Reject MAN_REJ_CMD_INVALID
        8:
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_NONE";

            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_CMD_INVALID";
            Exp_AckSlot := slot;

        // ============================================================
        // GROUP C: Command execution (START/STOP/RESET)
        // ============================================================
        
        // C1: START command OK -> AckOk TRUE, Owner = SCADA, Cmd written
        9:
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";
            "DB_PlcScada_MailBox".Req.Param1 := 7;

            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_SCADA";
            Exp_OwnerCurId := 0;
            Exp_Cmd := "CMD_START";
            Exp_CmdParam1 := 7;
            Exp_LastCmd := "CMD_START";

        // C2: ReleaseOwner OK -> Owner NONE
        10:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].OwnerCurId := 0;
            "DB_PlcScada_MailBox".Req.ReleaseOwner := TRUE;
            "DB_PlcScada_MailBox".Req.Commit := 1;

            Exp_ManualAllowed := FALSE;
            Exp_CurrentOwner := "OWNER_SCADA";
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_NONE";
            Exp_OwnerCurId := 0;

        // C3: ReleaseOwner FAIL (OwnerCurId != 0) -> MAN_REJ_ARBITER_FAIL
        11:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].OwnerCurId := 9;
            "DB_PlcScada_MailBox".Req.ReleaseOwner := TRUE;
            "DB_PlcScada_MailBox".Req.Commit := 1;

            Exp_ManualAllowed := FALSE;
            Exp_CurrentOwner := "OWNER_SCADA";
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_ARBITER_FAIL";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_SCADA";
            Exp_OwnerCurId := 9;

        // ============================================================
        // GROUP D: CMD_SET_FORCE (new functionality v3.2)
        // ============================================================
        
        // D1: CMD_SET_FORCE valid slot -> Force_Code set
        12:
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 5;  // Force_Code = 5

            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 5;
            Exp_LastCmd := "CMD_SET_FORCE";
            
            // Owner/Cmd NOT changed by CMD_SET_FORCE
            Exp_OwnerCur := "OWNER_NONE";
            Exp_Cmd := "CMD_NONE";

        // D2: CMD_SET_FORCE clear (Force_Code = 0)
        13:
            "DB_Mechs".Mechs[slot].Force_Code := 7;  // was set
            
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 0;  // clear

            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 0;
            Exp_LastCmd := "CMD_SET_FORCE";

        // D3: CMD_SET_FORCE unmapped slot -> Reject
        14:
            "DB_Mechs".Mechs[slot].DeviceType := "TYPE_NONE";
            "DB_Mechs".Mechs[slot].TypedIndex := UINT#16#FFFF;
            
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 3;

            Exp_ManualAllowed := FALSE;
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_SLOT_UNMAPPED";
            Exp_AckSlot := slot;
            Exp_ForceCode := 0;  // no change

        // D4: CMD_SET_FORCE NOT dependent on Owner
        15:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_ROUTE";
            "DB_Mechs".Mechs[slot].OwnerCurId := 3;
            
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 2;

            Exp_ManualAllowed := FALSE;  // due to Owner=ROUTE
            Exp_CurrentOwner := "OWNER_ROUTE";
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;  // CMD_SET_FORCE succeeds
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 2;
            Exp_LastCmd := "CMD_SET_FORCE";
            
            // Owner remains unchanged
            Exp_OwnerCur := "OWNER_ROUTE";
            Exp_OwnerCurId := 3;

        // D5: CMD_SET_FORCE NOT dependent on LocalManual
        16:
            "DB_Mechs".Mechs[slot].LocalManual := TRUE;
            
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 4;

            Exp_ManualAllowed := FALSE;  // due to LocalManual
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;  // CMD_SET_FORCE succeeds
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 4;
            Exp_LastCmd := "CMD_SET_FORCE";

        // D6: CMD_SET_FORCE NOT dependent on Enable_OK
        17:
            "DB_Mechs".Mechs[slot].Enable_OK := FALSE;
            
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 1;

            Exp_ManualAllowed := FALSE;  // due to Enable_OK
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;  // CMD_SET_FORCE succeeds
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 1;
            Exp_LastCmd := "CMD_SET_FORCE";

        // D7: CMD_SET_FORCE + START in two requests
        18:
            // Step 1: set Force_Code
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
            "DB_PlcScada_MailBox".Req.Param1 := 2;

            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 2;
            Exp_LastCmd := "CMD_SET_FORCE";
            
            // Execute once
            "FC_ManualMechCmdHandler"(LocalManualGlobal := LocalManualGlobal);
            
            // Step 2: START command (next commit)
            "DB_PlcScada_MailBox".Req.Commit := 2;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";
            "DB_PlcScada_MailBox".Req.Param1 := 0;

            Exp_AckCommit := 2;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_ForceCode := 2;  // remains
            Exp_LastCmd := "CMD_START";  // updated to START
            Exp_OwnerCur := "OWNER_SCADA";
            Exp_Cmd := "CMD_START";

        ELSE
            RETURN;
    END_CASE;

    // ------------------------------------------------------------------
    // ACT
    // ------------------------------------------------------------------
    "FC_ManualMechCmdHandler"(LocalManualGlobal := LocalManualGlobal);

    // ------------------------------------------------------------------
    // ASSERT
    // ------------------------------------------------------------------
    
    // Check statuses (PLC -> SCADA)
    IF "DB_PlcToScada_ManualMechStatus".StatusBySlot[slot].ManualAllowed <> Exp_ManualAllowed THEN
        FailMask := FailMask OR 16#0001;
    END_IF;
    IF "DB_PlcToScada_ManualMechStatus".StatusBySlot[slot].CurrentOwner <> Exp_CurrentOwner THEN
        FailMask := FailMask OR 16#0002;
    END_IF;
    IF "DB_PlcToScada_ManualMechStatus".StatusBySlot[slot].CurrentStatus <> Exp_CurrentStatus THEN
        FailMask := FailMask OR 16#0004;
    END_IF;

    // Check ACK (PLC -> SCADA)
    IF "DB_PlcScada_MailBox".Ack.AckCommit <> Exp_AckCommit THEN 
        FailMask := FailMask OR 16#0010; 
    END_IF;
    IF "DB_PlcScada_MailBox".Ack.AckOk <> Exp_AckOk THEN 
        FailMask := FailMask OR 16#0020; 
    END_IF;
    IF "DB_PlcScada_MailBox".Ack.RejectCode <> Exp_RejectCode THEN 
        FailMask := FailMask OR 16#0040; 
    END_IF;
    IF "DB_PlcScada_MailBox".Ack.Slot <> Exp_AckSlot THEN 
        FailMask := FailMask OR 16#0080; 
    END_IF;

    // Check mechanism (internal state)
    IF "DB_Mechs".Mechs[slot].OwnerCur <> Exp_OwnerCur THEN 
        FailMask := FailMask OR 16#0100; 
    END_IF;
    IF "DB_Mechs".Mechs[slot].OwnerCurId <> Exp_OwnerCurId THEN 
        FailMask := FailMask OR 16#0200; 
    END_IF;
    IF "DB_Mechs".Mechs[slot].Cmd <> Exp_Cmd THEN 
        FailMask := FailMask OR 16#0400; 
    END_IF;
    IF "DB_Mechs".Mechs[slot].CmdParam1 <> Exp_CmdParam1 THEN 
        FailMask := FailMask OR 16#0800; 
    END_IF;
    
    // Check Force_Code
    IF "DB_Mechs".Mechs[slot].Force_Code <> Exp_ForceCode THEN 
        FailMask := FailMask OR 16#1000; 
    END_IF;
    
    // Check LastCmd
    IF "DB_Mechs".Mechs[slot].LastCmd <> Exp_LastCmd THEN 
        FailMask := FailMask OR 16#2000; 
    END_IF;

    Failed := (FailMask <> 0);
    Passed := NOT Failed;
    
END_FUNCTION_BLOCK