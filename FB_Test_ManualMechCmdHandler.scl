// ==============================================================================
// FB_Test_ManualMechCmdHandler - Unit tests for FC_ManualMechCmdHandler
// ==============================================================================
// Version: 3.3 (CMD_SET_FORCE + CMD_RELEASE_OWNER as commands)
// Date: 2026-01-27
// ==============================================================================

FUNCTION_BLOCK "FB_Test_ManualMechCmdHandler"
{ S7_Optimized_Access := 'TRUE' }

VAR_INPUT
    Run    : BOOL;   // TRUE = execute test
    CaseId : INT;    // test case number
END_VAR

VAR_OUTPUT
    Passed   : BOOL;
    Failed   : BOOL;
    FailMask : DWORD;
END_VAR

VAR
    slot : UINT;

    LocalManualGlobal : BOOL;

    Exp_ManualAllowed : BOOL;
    Exp_CurrentOwner  : USINT;
    Exp_CurrentStatus : UINT;

    Exp_AckCommit  : UDINT;
    Exp_AckOk      : BOOL;
    Exp_RejectCode : USINT;
    Exp_AckSlot    : UINT;

    Exp_OwnerCur   : USINT;
    Exp_OwnerCurId : UINT;
    Exp_Cmd        : USINT;
    Exp_CmdParam1  : INT;
    Exp_ForceCode  : INT;
    Exp_LastCmd    : USINT;
END_VAR

BEGIN
    Passed := FALSE;
    Failed := FALSE;
    FailMask := 0;

    IF NOT Run THEN
        RETURN;
    END_IF;

    slot := 5;
    LocalManualGlobal := FALSE;

    // ------------------------------------------------------------------
    // ARRANGE - baseline "healthy" state
    // ------------------------------------------------------------------
    "DB_Mechs".Mechs[slot].DeviceType := "TYPE_REDLER";
    "DB_Mechs".Mechs[slot].TypedIndex := 0;
    "DB_Mechs".Mechs[slot].Enable_OK := TRUE;
    "DB_Mechs".Mechs[slot].LocalManual := FALSE;
    "DB_Mechs".Mechs[slot].Cmd := "CMD_NONE";
    "DB_Mechs".Mechs[slot].CmdParam1 := 0;
    "DB_Mechs".Mechs[slot].Force_Code := 0;
    "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_NONE";
    "DB_Mechs".Mechs[slot].OwnerCurId := 0;
    "DB_Mechs".Mechs[slot].LastCmd := "CMD_NONE";
    "DB_Mechs".Mechs[slot].FLTCode := "FLT_NONE";
    "DB_Mechs".Mechs[slot].Status := "STS_IDLE";

    "DB_PlcScada_MailBox".Req.Slot := slot;
    "DB_PlcScada_MailBox".Req.Cmd := "CMD_NONE";
    "DB_PlcScada_MailBox".Req.Param1 := 0;
    "DB_PlcScada_MailBox".Req.Commit := 0;

    "DB_PlcScada_MailBox".Ack.AckCommit := 0;
    "DB_PlcScada_MailBox".Ack.AckOk := FALSE;
    "DB_PlcScada_MailBox".Ack.RejectCode := 0;
    "DB_PlcScada_MailBox".Ack.Slot := 0;

    Exp_ManualAllowed := TRUE;
    Exp_CurrentOwner := "DB_Mechs".Mechs[slot].OwnerCur;
    Exp_CurrentStatus := "DB_Mechs".Mechs[slot].Status;

    Exp_AckCommit := 0;
    Exp_AckOk := FALSE;
    Exp_RejectCode := 0;
    Exp_AckSlot := 0;

    Exp_OwnerCur := "DB_Mechs".Mechs[slot].OwnerCur;
    Exp_OwnerCurId := "DB_Mechs".Mechs[slot].OwnerCurId;
    Exp_Cmd := "DB_Mechs".Mechs[slot].Cmd;
    Exp_CmdParam1 := "DB_Mechs".Mechs[slot].CmdParam1;
    Exp_ForceCode := "DB_Mechs".Mechs[slot].Force_Code;
    Exp_LastCmd := "DB_Mechs".Mechs[slot].LastCmd;

    // ------------------------------------------------------------------
    // TEST CASES
    // ------------------------------------------------------------------
    CASE CaseId OF
        // ============================================================
        // GROUP A: ManualAllowed calculation (unchanged)
        // ============================================================
        
        1: ;// A1: baseline
        2: LocalManualGlobal := TRUE; Exp_ManualAllowed := FALSE;  // A2
        3: "DB_Mechs".Mechs[slot].DeviceType := "TYPE_NONE";       // A3
           "DB_Mechs".Mechs[slot].TypedIndex := UINT#16#FFFF;
           Exp_ManualAllowed := FALSE;

        // ============================================================
        // GROUP B: Slot validation (unchanged)
        // ============================================================
        
        4: "DB_PlcScada_MailBox".Req.Slot := UINT#300;  // B1
           "DB_PlcScada_MailBox".Req.Commit := 1;
           Exp_AckCommit := 1; Exp_AckOk := FALSE;
           Exp_RejectCode := "MAN_REJ_SLOT_UNMAPPED"; Exp_AckSlot := UINT#300;

        // ============================================================
        // GROUP C: Command execution (START/STOP/RESET - unchanged)
        // ============================================================
        
        5: "DB_PlcScada_MailBox".Req.Commit := 1;  // C1: START
           "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";
           "DB_PlcScada_MailBox".Req.Param1 := 7;
           Exp_AckCommit := 1; Exp_AckOk := TRUE; Exp_RejectCode := "MAN_REJ_OK";
           Exp_AckSlot := slot; Exp_OwnerCur := "OWNER_SCADA";
           Exp_Cmd := "CMD_START"; Exp_CmdParam1 := 7; Exp_LastCmd := "CMD_START";

        // ============================================================
        // GROUP D: CMD_SET_FORCE (unchanged)
        // ============================================================
        
        6: "DB_PlcScada_MailBox".Req.Commit := 1;  // D1
           "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
           "DB_PlcScada_MailBox".Req.Param1 := 5;
           Exp_AckCommit := 1; Exp_AckOk := TRUE; Exp_RejectCode := "MAN_REJ_OK";
           Exp_AckSlot := slot; Exp_ForceCode := 5; Exp_LastCmd := "CMD_SET_FORCE";

        7: "DB_Mechs".Mechs[slot].Force_Code := 7;  // D2: clear
           "DB_PlcScada_MailBox".Req.Commit := 1;
           "DB_PlcScada_MailBox".Req.Cmd := "CMD_SET_FORCE";
           "DB_PlcScada_MailBox".Req.Param1 := 0;
           Exp_AckCommit := 1; Exp_AckOk := TRUE; Exp_RejectCode := "MAN_REJ_OK";
           Exp_AckSlot := slot; Exp_ForceCode := 0; Exp_LastCmd := "CMD_SET_FORCE";

        // ============================================================
        // GROUP E: CMD_RELEASE_OWNER üÜï
        // ============================================================
        
        // E1: Release OK (owner SCADA)
        8:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].OwnerCurId := 0;
            "DB_Mechs".Mechs[slot].Status := "STS_IDLE";  // ‚úÖ IDLE
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_ManualAllowed := FALSE;  // owner –±—É–≤ SCADA
            Exp_CurrentOwner := "OWNER_SCADA";
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_NONE";   // –∑–≤—ñ–ª—å–Ω–µ–Ω–æ!
            Exp_OwnerCurId := 0;
            Exp_LastCmd := "CMD_RELEASE_OWNER";  // ‚úÖ —ñ—Å—Ç–æ—Ä—ñ—è

        // E2: Release FAIL (owner mismatch - OwnerCurId != 0)
        9:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].OwnerCurId := 9;  // –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î!
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_ManualAllowed := FALSE;
            Exp_CurrentOwner := "OWNER_SCADA";
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;  // –Ω–µ –≤–¥–∞–ª–æ—Å—è
            Exp_RejectCode := "MAN_REJ_ARBITER_FAIL";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_SCADA";   // –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è
            Exp_OwnerCurId := 9;
            Exp_LastCmd := "CMD_NONE";  // ‚ùå –Ω–µ –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è –ø—Ä–∏ fail

        // E3: Release FAIL (owner ROUTE - –Ω–µ –º–æ–∂—É –∑–≤—ñ–ª—å–Ω–∏—Ç–∏ —á—É–∂–µ)
        10:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_ROUTE";
            "DB_Mechs".Mechs[slot].OwnerCurId := 2;
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_ManualAllowed := FALSE;
            Exp_CurrentOwner := "OWNER_ROUTE";
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;
            Exp_RejectCode := "MAN_REJ_ARBITER_FAIL";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_ROUTE";  // –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è
            Exp_OwnerCurId := 2;

        // E4: Release when owner already NONE (edge case)
        11:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_NONE";
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;  // fail (owner –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î)
            Exp_RejectCode := "MAN_REJ_ARBITER_FAIL";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_NONE";

        // E5: Release + CMD_START in sequence (two requests)
        12:
            // Setup: –º–µ—Ö–∞–Ω—ñ–∑–º –∑–∞–π–Ω—è—Ç–æ SCADA, –∞–ª–µ –≤ IDLE
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].OwnerCurId := 0;
            "DB_Mechs".Mechs[slot].Status := "STS_IDLE";  // ‚úÖ IDLE
            
            // Step 1: Release
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_NONE";
            Exp_LastCmd := "CMD_RELEASE_OWNER";
            
            // Execute once
            "FC_ManualMechCmdHandler"(LocalManualGlobal := LocalManualGlobal);
            
            // Step 2: START (new commit)
            "DB_PlcScada_MailBox".Req.Commit := 2;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_START";

            Exp_AckCommit := 2;
            Exp_AckOk := TRUE;
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_OwnerCur := "OWNER_SCADA";  // –∑–∞—Ö–≤–∞—á–µ–Ω–æ –∑–Ω–æ–≤—É
            Exp_Cmd := "CMD_START";
            Exp_LastCmd := "CMD_START";

        // E6: Release NOT dependent on LocalManual
        13:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].LocalManual := TRUE;  // local!
            "DB_Mechs".Mechs[slot].Status := "STS_IDLE";  // ‚úÖ IDLE
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_ManualAllowed := FALSE;  // due to LocalManual
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;  // –∞–ª–µ release –ø—Ä–æ—Ö–æ–¥–∏—Ç—å!
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_NONE";
            Exp_LastCmd := "CMD_RELEASE_OWNER";

        // E7: Release NOT dependent on Enable_OK
        14:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].Enable_OK := FALSE;  // disabled!
            "DB_Mechs".Mechs[slot].Status := "STS_IDLE";  // ‚úÖ IDLE
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_ManualAllowed := FALSE;  // due to Enable_OK
            Exp_AckCommit := 1;
            Exp_AckOk := TRUE;  // –∞–ª–µ release –ø—Ä–æ—Ö–æ–¥–∏—Ç—å!
            Exp_RejectCode := "MAN_REJ_OK";
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_NONE";
            Exp_LastCmd := "CMD_RELEASE_OWNER";

        // E8: Release FAIL (–º–µ—Ö–∞–Ω—ñ–∑–º –Ω–µ –≤ IDLE) üÜï
        15:
            "DB_Mechs".Mechs[slot].OwnerCur := "OWNER_SCADA";
            "DB_Mechs".Mechs[slot].Status := "STS_RUNNING";  // –ø—Ä–∞—Ü—é—î!
            "DB_PlcScada_MailBox".Req.Commit := 1;
            "DB_PlcScada_MailBox".Req.Cmd := "CMD_RELEASE_OWNER";

            Exp_ManualAllowed := FALSE;  // owner –∑–∞–π–Ω—è—Ç–æ
            Exp_CurrentOwner := "OWNER_SCADA";
            Exp_CurrentStatus := "STS_RUNNING";
            Exp_AckCommit := 1;
            Exp_AckOk := FALSE;  // –≤—ñ–¥–º–æ–≤–∞!
            Exp_RejectCode := "MAN_REJ_NOT_IDLE";  // –ø—Ä–∏—á–∏–Ω–∞
            Exp_AckSlot := slot;
            Exp_OwnerCur := "OWNER_SCADA";  // –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è
            Exp_LastCmd := "CMD_NONE";  // –Ω–µ –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è

        ELSE
            RETURN;
    END_CASE;

    // ------------------------------------------------------------------
    // ACT
    // ------------------------------------------------------------------
    "FC_ManualMechCmdHandler"(LocalManualGlobal := LocalManualGlobal);

    // ------------------------------------------------------------------
    // ASSERT
    // ------------------------------------------------------------------
    
    IF "DB_PlcToScada_ManualMechStatus".StatusBySlot[slot].ManualAllowed <> Exp_ManualAllowed THEN
        FailMask := FailMask OR 16#0001;
    END_IF;
    IF "DB_PlcToScada_ManualMechStatus".StatusBySlot[slot].CurrentOwner <> Exp_CurrentOwner THEN
        FailMask := FailMask OR 16#0002;
    END_IF;
    IF "DB_PlcToScada_ManualMechStatus".StatusBySlot[slot].CurrentStatus <> Exp_CurrentStatus THEN
        FailMask := FailMask OR 16#0004;
    END_IF;

    IF "DB_PlcScada_MailBox".Ack.AckCommit <> Exp_AckCommit THEN 
        FailMask := FailMask OR 16#0010; 
    END_IF;
    IF "DB_PlcScada_MailBox".Ack.AckOk <> Exp_AckOk THEN 
        FailMask := FailMask OR 16#0020; 
    END_IF;
    IF "DB_PlcScada_MailBox".Ack.RejectCode <> Exp_RejectCode THEN 
        FailMask := FailMask OR 16#0040; 
    END_IF;
    IF "DB_PlcScada_MailBox".Ack.Slot <> Exp_AckSlot THEN 
        FailMask := FailMask OR 16#0080; 
    END_IF;

    IF "DB_Mechs".Mechs[slot].OwnerCur <> Exp_OwnerCur THEN 
        FailMask := FailMask OR 16#0100; 
    END_IF;
    IF "DB_Mechs".Mechs[slot].OwnerCurId <> Exp_OwnerCurId THEN 
        FailMask := FailMask OR 16#0200; 
    END_IF;
    IF "DB_Mechs".Mechs[slot].Cmd <> Exp_Cmd THEN 
        FailMask := FailMask OR 16#0400; 
    END_IF;
    IF "DB_Mechs".Mechs[slot].CmdParam1 <> Exp_CmdParam1 THEN 
        FailMask := FailMask OR 16#0800; 
    END_IF;
    
    IF "DB_Mechs".Mechs[slot].Force_Code <> Exp_ForceCode THEN 
        FailMask := FailMask OR 16#1000; 
    END_IF;
    
    IF "DB_Mechs".Mechs[slot].LastCmd <> Exp_LastCmd THEN 
        FailMask := FailMask OR 16#2000; 
    END_IF;

    Failed := (FailMask <> 0);
    Passed := NOT Failed;
    
END_FUNCTION_BLOCK
