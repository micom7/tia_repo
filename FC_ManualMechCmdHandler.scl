// File: FC_ManualMechCmdHandler.scl
FUNCTION "FC_ManualMechCmdHandler" : VOID
{ S7_Optimized_Access := 'TRUE' }

VAR_INPUT
    LocalManualGlobal : BOOL;
END_VAR

VAR_TEMP
    i          : INT;
    commitIn   : UDINT;
    allowed    : BOOL;
    ok         : BOOL;
    rej        : USINT;
    isLocal    : BOOL;
    isMapped   : BOOL;
END_VAR

BEGIN
    FOR i := 0 TO 255 DO
        
        // ===== 1) Перевірка мапінгу слоту =====
        isMapped := ("DB_Mechs".Mechs[i].DeviceType <> "DB_Const".TYPE_NONE)
                    AND ("DB_Mechs".Mechs[i].TypedIndex <> UINT#16#FFFF);
        
        // ===== 2) Обчислення ManualAllowed =====
        isLocal := LocalManualGlobal OR "DB_Mechs".Mechs[i].LocalManual;
        
        IF isMapped THEN
            allowed := ("DB_Mechs".Mechs[i].OwnerCur = "DB_Const".OWNER_NONE)
                       AND (NOT isLocal)
                       AND ("DB_Mechs".Mechs[i].Enable_OK);
        ELSE
            allowed := FALSE;
        END_IF;
        
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].ManualAllowed := allowed;
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].CurrentOwner  := "DB_Mechs".Mechs[i].OwnerCur;
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].CurrentStatus := "DB_Mechs".Mechs[i].Status;
        
        // ===== 3) Перевірка нового commit =====
        commitIn := "DB_ScadaToPlc_ManualMechCmd".CmdBySlot[i].Commit;
        
        IF commitIn = "DB_Plc_ManualMechAux".LastCommitSeen[i] THEN
            CONTINUE;  // немає нових команд
        END_IF;
        
        // Зафіксувати commit
        "DB_Plc_ManualMechAux".LastCommitSeen[i] := commitIn;
        
        // ===== 4) Валідація =====
        rej := "DB_Const".MAN_REJ_OK;
        
        IF NOT isMapped THEN
            rej := "DB_Const".MAN_REJ_SLOT_UNMAPPED;
            
        ELSIF isLocal THEN
            rej := "DB_Const".MAN_REJ_LOCAL_MANUAL;
            
        ELSIF NOT "DB_Mechs".Mechs[i].Enable_OK THEN
            rej := "DB_Const".MAN_REJ_NOT_ENABLED;
            
        ELSIF ("DB_Mechs".Mechs[i].OwnerCur <> "DB_Const".OWNER_NONE)
              AND ("DB_Mechs".Mechs[i].OwnerCur <> "DB_Const".OWNER_SCADA) THEN
            rej := "DB_Const".MAN_REJ_OWNER_BUSY;
        END_IF;
        
        // ===== 5) Обробка ReleaseOwner =====
        IF (rej = "DB_Const".MAN_REJ_OK) 
           AND "DB_ScadaToPlc_ManualMechCmd".CmdBySlot[i].ReleaseOwner THEN
            
            ok := "FC_ArbiterMech"(
                LocalManualGlobal := LocalManualGlobal,
                OwnerReq          := "DB_Const".OWNER_SCADA,
                OwnerReqId        := UINT#0,
                ReqCmd            := "DB_Const".CMD_NONE,
                ReqParam1         := 0,
                ReqForce          := 0,
                ReleaseOwner      := TRUE,
                LockOnly          := FALSE,
                M                 := "DB_Mechs".Mechs[i]
            );
            
            IF ok THEN
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckOk := TRUE;
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].RejectCode := "DB_Const".MAN_REJ_OK;
            ELSE
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckOk := FALSE;
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].RejectCode := "DB_Const".MAN_REJ_ARBITER_FAIL;
            END_IF;
            
            "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckCommit := commitIn;
            
            CONTINUE;
        END_IF;
        
        // ===== 6) Валідація команди =====
        IF rej = "DB_Const".MAN_REJ_OK THEN
            IF "DB_ScadaToPlc_ManualMechCmd".CmdBySlot[i].Cmd = "DB_Const".CMD_NONE THEN
                rej := "DB_Const".MAN_REJ_CMD_INVALID;
            END_IF;
        END_IF;
        
        // ===== 7) Виконання команди =====
        IF rej = "DB_Const".MAN_REJ_OK THEN
            ok := "FC_ArbiterMech"(
                LocalManualGlobal := LocalManualGlobal,
                OwnerReq          := "DB_Const".OWNER_SCADA,
                OwnerReqId        := UINT#0,
                ReqCmd            := "DB_ScadaToPlc_ManualMechCmd".CmdBySlot[i].Cmd,
                ReqParam1         := "DB_ScadaToPlc_ManualMechCmd".CmdBySlot[i].Param1,
                ReqForce          := "DB_ScadaToPlc_ManualMechCmd".CmdBySlot[i].Force_Code,
                ReleaseOwner      := FALSE,
                LockOnly          := FALSE,
                M                 := "DB_Mechs".Mechs[i]
            );
            
            IF ok THEN
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckOk := TRUE;
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].RejectCode := "DB_Const".MAN_REJ_OK;
            ELSE
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckOk := FALSE;
                "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].RejectCode := "DB_Const".MAN_REJ_ARBITER_FAIL;
            END_IF;
        ELSE
            // Команда відхилена на етапі валідації
            "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckOk := FALSE;
            "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].RejectCode := rej;
        END_IF;
        
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].AckCommit := commitIn;
        "DB_Plc_ManualMechAux".LastResultCode[i] := rej;
        
    END_FOR;
    
END_FUNCTION