// ==============================================================================
// FC_ManualMechCmdHandler - –û–±—Ä–æ–±–∫–∞ —Ä—É—á–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ MailBox
// ==============================================================================
// –í–µ—Ä—Å—ñ—è: 3.1 (–∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é SetForceOnly)
// –î–∞—Ç–∞: 2026-01-20
// ==============================================================================

FUNCTION "FC_ManualMechCmdHandler" : VOID
{ S7_Optimized_Access := 'TRUE' }

VAR_INPUT
    LocalManualGlobal : BOOL;
END_VAR

VAR_TEMP
    i          : INT;
    slot       : UINT;
    commitIn   : UDINT;
    lastAck    : UDINT;
    allowed    : BOOL;
    ok         : BOOL;
    rej        : USINT;
    isLocal    : BOOL;
    isMapped   : BOOL;
END_VAR

BEGIN
    // =========================================================
    // –ß–ê–°–¢–ò–ù–ê 1: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—ñ–≤ –¥–ª—è –≤—Å—ñ—Ö —Å–ª–æ—Ç—ñ–≤ (PLC ‚Üí SCADA)
    // =========================================================
    FOR i := 0 TO 255 DO
        
        isMapped := ("DB_Mechs".Mechs[i].DeviceType <> TYPE_NONE)
                    AND ("DB_Mechs".Mechs[i].TypedIndex <> UINT#16#FFFF);
        
        isLocal := LocalManualGlobal OR "DB_Mechs".Mechs[i].LocalManual;
        
        IF isMapped THEN
            allowed := ("DB_Mechs".Mechs[i].OwnerCur = OWNER_NONE)
                       AND (NOT isLocal)
                       AND ("DB_Mechs".Mechs[i].Enable_OK);
        ELSE
            allowed := FALSE;
        END_IF;
        
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].ManualAllowed := allowed;
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].CurrentOwner  := "DB_Mechs".Mechs[i].OwnerCur;
        "DB_PlcToScada_ManualMechStatus".StatusBySlot[i].CurrentStatus := "DB_Mechs".Mechs[i].Status;
        
    END_FOR;
    
    // =========================================================
    // –ß–ê–°–¢–ò–ù–ê 2: –û–±—Ä–æ–±–∫–∞ MailBox –∫–æ–º–∞–Ω–¥–∏ (SCADA ‚Üí PLC)
    // =========================================================
    commitIn := "DB_PlcScada_MailBox".Req.Commit;
    lastAck  := "DB_PlcScada_MailBox".Ack.AckCommit;
    
    // –ù–µ–º–∞—î –Ω–æ–≤–æ—ó –∫–æ–º–∞–Ω–¥–∏ ‚Äî –≤–∏—Ö–æ–¥–∏–º–æ
    IF commitIn = lastAck THEN
        RETURN;
    END_IF;
    
    // –ß–∏—Ç–∞—î–º–æ —Å–ª–æ—Ç –∑ –∑–∞–ø–∏—Ç—É
    slot := "DB_PlcScada_MailBox".Req.Slot;
    
    // =========================================================
    // –í–ê–õ–Ü–î–ê–¶–Ü–Ø –°–õ–û–¢–£ (–±–∞–∑–æ–≤–∞, –¥–ª—è –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π)
    // =========================================================
    IF slot > 255 THEN
        "DB_PlcScada_MailBox".Ack.AckCommit  := commitIn;
        "DB_PlcScada_MailBox".Ack.AckOk      := FALSE;
        "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_SLOT_UNMAPPED;
        "DB_PlcScada_MailBox".Ack.Slot       := slot;
        RETURN;
    END_IF;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–∞–ø—ñ–Ω–≥—É
    isMapped := ("DB_Mechs".Mechs[slot].DeviceType <> TYPE_NONE)
                AND ("DB_Mechs".Mechs[slot].TypedIndex <> UINT#16#FFFF);
    
    IF NOT isMapped THEN
        "DB_PlcScada_MailBox".Ack.AckCommit  := commitIn;
        "DB_PlcScada_MailBox".Ack.AckOk      := FALSE;
        "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_SLOT_UNMAPPED;
        "DB_PlcScada_MailBox".Ack.Slot       := slot;
        RETURN;
    END_IF;
    
    // =========================================================
    // üÜï –û–ü–ï–†–ê–¶–Ü–Ø 1: SetForceOnly (–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Force_Code)
    // =========================================================
    IF "DB_PlcScada_MailBox".Req.SetForceOnly THEN
        
        // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Force_Code –Ω–∞–ø—Ä—è–º—É
        "DB_Mechs".Mechs[slot].Force_Code := "DB_PlcScada_MailBox".Req.Force_Code;
        
        // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —É—Å–ø—ñ—à–Ω—É –æ–ø–µ—Ä–∞—Ü—ñ—é
        "DB_PlcScada_MailBox".Ack.AckCommit  := commitIn;
        "DB_PlcScada_MailBox".Ack.AckOk      := TRUE;
        "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_OK;
        "DB_PlcScada_MailBox".Ack.Slot       := slot;
        
        RETURN;  // SetForceOnly ‚Äî –æ–∫—Ä–µ–º–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è, –≤–∏—Ö–æ–¥–∏–º–æ
    END_IF;
    
    // =========================================================
    // –î–∞–ª—ñ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥ (START/STOP/RESET)
    // =========================================================
    
    isLocal := LocalManualGlobal OR "DB_Mechs".Mechs[slot].LocalManual;
    
    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–ª—è –∫–æ–º–∞–Ω–¥ (–Ω–µ –¥–ª—è SetForceOnly)
    rej := MAN_REJ_OK;
    
    IF isLocal THEN
        rej := MAN_REJ_LOCAL_MANUAL;
        
    ELSIF NOT "DB_Mechs".Mechs[slot].Enable_OK THEN
        rej := MAN_REJ_NOT_ENABLED;
        
    ELSIF ("DB_Mechs".Mechs[slot].OwnerCur <> OWNER_NONE)
          AND ("DB_Mechs".Mechs[slot].OwnerCur <> OWNER_SCADA) THEN
        rej := MAN_REJ_OWNER_BUSY;
    END_IF;
    
    // =========================================================
    // –û–ü–ï–†–ê–¶–Ü–Ø 2: ReleaseOwner (–∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è ownership)
    // =========================================================
    IF (rej = MAN_REJ_OK) 
       AND "DB_PlcScada_MailBox".Req.ReleaseOwner THEN
        
        ok := "FC_ArbiterMech"(
            LocalManualGlobal := LocalManualGlobal,
            OwnerReq          := OWNER_SCADA,
            OwnerReqId        := UINT#0,
            ReqCmd            := CMD_NONE,
            ReqParam1         := 0,
            ReleaseOwner      := TRUE,
            LockOnly          := FALSE,
            M                 := "DB_Mechs".Mechs[slot]
        );
        
        "DB_PlcScada_MailBox".Ack.AckCommit  := commitIn;
        "DB_PlcScada_MailBox".Ack.Slot       := slot;
        
        IF ok THEN
            "DB_PlcScada_MailBox".Ack.AckOk      := TRUE;
            "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_OK;
        ELSE
            "DB_PlcScada_MailBox".Ack.AckOk      := FALSE;
            "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_ARBITER_FAIL;
        END_IF;
        
        RETURN;
    END_IF;
    
    // =========================================================
    // –û–ü–ï–†–ê–¶–Ü–Ø 3: –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ (START/STOP/RESET)
    // =========================================================
    
    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥–∏
    IF rej = MAN_REJ_OK THEN
        IF "DB_PlcScada_MailBox".Req.Cmd = CMD_NONE THEN
            rej := MAN_REJ_CMD_INVALID;
        END_IF;
    END_IF;
    
    // –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ —á–µ—Ä–µ–∑ –∞—Ä–±—ñ—Ç—Ä
    IF rej = MAN_REJ_OK THEN
        ok := "FC_ArbiterMech"(
            LocalManualGlobal := LocalManualGlobal,
            OwnerReq          := OWNER_SCADA,
            OwnerReqId        := UINT#0,
            ReqCmd            := "DB_PlcScada_MailBox".Req.Cmd,
            ReqParam1         := "DB_PlcScada_MailBox".Req.Param1,
            ReleaseOwner      := FALSE,
            LockOnly          := FALSE,
            M                 := "DB_Mechs".Mechs[slot]
        );
        
        IF ok THEN
            "DB_PlcScada_MailBox".Ack.AckOk      := TRUE;
            "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_OK;
        ELSE
            "DB_PlcScada_MailBox".Ack.AckOk      := FALSE;
            "DB_PlcScada_MailBox".Ack.RejectCode := MAN_REJ_ARBITER_FAIL;
        END_IF;
    ELSE
        "DB_PlcScada_MailBox".Ack.AckOk      := FALSE;
        "DB_PlcScada_MailBox".Ack.RejectCode := rej;
    END_IF;
    
    // –§—ñ–Ω–∞–ª—å–Ω–∏–π ACK
    "DB_PlcScada_MailBox".Ack.AckCommit := commitIn;
    "DB_PlcScada_MailBox".Ack.Slot      := slot;
    
END_FUNCTION