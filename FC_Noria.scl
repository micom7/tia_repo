FUNCTION "FC_Noria" : Void
{ S7_Optimized_Access := 'TRUE' }
VERSION : 0.1
   VAR_IN_OUT 
      N : "UDT_Noria";   // // Типізована норія (I/O + таймінги)
      B : "UDT_BaseMechanism";   // // Базовий механізм слоту (Cmd/Status/FLT/Owner..
   END_VAR

   VAR_TEMP 
      startTimeout : Bool;
      speedTimeout : Bool;
      elapsedMs : DInt;
      nowTck : DInt;
      forceBreaker : Bool;
      forceAlingment : Bool;
      forceSpeed : Bool;
      isFault : Bool;
      isBlocked : Bool;
   END_VAR


BEGIN
	// ============================================================================
	// FC_Noria (Refactored to CASE)
	// ============================================================================
	
	REGION "Стани та формування"
	    // BIT1 (2)  - подавити FLT_BREAKER
	    // BIT2 (4)  - подавити FLT_SPEED (не стартує / втрата швидкості)
	    // BIT4 (16) - подавити FLT_ALINGMENT
	    #forceBreaker := (#B.Force_Code AND 2) <> 0;
	    #forceSpeed := (#B.Force_Code AND 4) <> 0;
	    #forceAlingment := (#B.Force_Code AND 16) <> 0;
	END_REGION
	
	REGION "1) RESET та лач FAULT"
	    IF #B.Cmd = "CMD_RESET" THEN
	        #B.FLTCode := "FLT_NONE";
	        #B.Status := "STS_IDLE";
	        #N.StartMs := 0;
	        #N.SpeedLostMs := 0;
	        #B.LastCmd := #B.Cmd;
	    END_IF;
	    
	    #isFault := (#B.Status = "STS_FAULT");
	END_REGION
	
	REGION "2) Передумови керування (Enable / Ручний)"
	    IF NOT #B.Enable_OK THEN
	        #B.Status := "STS_DISABLED";
	        #B.OwnerCur := 0;
	        #B.OwnerCurId := 0;
	        #N.StartMs := 0;
	        #N.SpeedLostMs := 0;
	    ELSIF #B.LocalManual THEN
	        #B.Status := "STS_LOCAL";
	        #B.OwnerCur := 0;
	        #B.OwnerCurId := 0;
	        #N.StartMs := 0;
	        #N.SpeedLostMs := 0;
	    ELSIF (#B.Status = "STS_DISABLED") OR (#B.Status = "STS_LOCAL") THEN
	        // Автоматичний вихід з DISABLED/LOCAL при знятті блокувань
	        #B.Status := "STS_IDLE";
	    END_IF;
	    
	    #isBlocked := (#B.Status = "STS_DISABLED") OR (#B.Status = "STS_LOCAL");
	END_REGION
	
	REGION "3) Фіксація останньої команди"
	    IF #B.Cmd <> "CMD_NONE" THEN
	        #B.LastCmd := #B.Cmd;
	    END_IF;
	END_REGION
	
	REGION "4) Місцеві аварії"
	    IF (NOT #isFault) AND (NOT #isBlocked) THEN
	        // Пріоритет аварій: BREAKER > ALINGMENT
	        IF (NOT #N.DI_Breaker_OK) AND (NOT #forceBreaker) THEN
	            #B.FLTCode := "FLT_BREAKER";
	            #B.Status := "STS_FAULT";
	        ELSIF (NOT #N.DI_Alingment_OK) AND (NOT #forceAlingment) THEN
	            #B.FLTCode := "FLT_ALINGMENT"; // Збережено ваш оригінальний typo
	            #B.Status := "STS_FAULT";
	        END_IF;
	        #isFault := (#B.Status = "STS_FAULT");
	    END_IF;
	END_REGION
	
	REGION "5 & 6) Машина станів та обробка команд"
	    IF (NOT #isFault) AND (NOT #isBlocked) THEN
	        
	        CASE #B.Status OF
	                
	            "STS_IDLE":
	                IF #B.Cmd = "CMD_START" THEN
	                    #B.Status := "STS_STARTING";
	                    #N.StartMs := TIME_TCK();
	                END_IF;
	                
	            "STS_STARTING":
	                // Контроль набору швидкості
	                IF #N.DI_Speed_OK OR #forceSpeed THEN
	                    #B.Status := "STS_RUNNING";
	                    #N.SpeedLostMs := 0;
	                ELSE
	                    #startTimeout := "FC_TimeElapsedMs"(
	                                                        StartTck := #N.StartMs,
	                                                        TimeoutMs := "TimeoutMs_Noria_Start",
	                                                        ElapsedMs => #elapsedMs,
	                                                        NowTck => #nowTck
	                    );
	                    
	                    IF #startTimeout THEN
	                        #B.FLTCode := "FLT_NO_RUNFB";
	                        #B.Status := "STS_FAULT";
	                        #isFault := TRUE;
	                    END_IF;
	                END_IF;
	                
	                IF #B.Cmd = "CMD_STOP" THEN
	                    #B.Status := "STS_STOPPING";
	                END_IF;
	                
	            "STS_RUNNING":
	                // Контроль втрати швидкості з фільтром часу (SpeedPause)
	                IF #N.DI_Speed_OK OR #forceSpeed THEN
	                    #N.SpeedLostMs := 0;
	                ELSE
	                    IF #N.SpeedLostMs = 0 THEN
	                        #N.SpeedLostMs := TIME_TCK();
	                    END_IF;
	                    
	                    #speedTimeout := "FC_TimeElapsedMs"(
	                                                        StartTck := #N.SpeedLostMs,
	                                                        TimeoutMs := "TimeoutMs_Noria_SpeedPause",
	                                                        ElapsedMs => #elapsedMs,
	                                                        NowTck => #nowTck);
	                    
	                    IF #speedTimeout THEN
	                        #B.FLTCode := "FLT_NO_RUNFB";
	                        #B.Status := "STS_FAULT";
	                        #isFault := TRUE;
	                    END_IF;
	                END_IF;
	                
	                IF #B.Cmd = "CMD_STOP" THEN
	                    #B.Status := "STS_STOPPING";
	                END_IF;
	                
	            "STS_STOPPING":
	                // Очікуємо повної зупинки датчика швидкості
	                IF (NOT #N.DI_Speed_OK) THEN
	                    #B.Status := "STS_IDLE";
	                    #N.StartMs := 0;
	                    #N.SpeedLostMs := 0;
	                END_IF;
	                
	            ELSE
	                #B.Status := "STS_IDLE";
	        END_CASE;
	        
	    END_IF;
	END_REGION
	

	REGION "7) Формування виходу DO_Run"
	    // DO_Run — похідний від фінального Status.
	    // У FAULT / DISABLED / LOCAL -> FALSE автоматично.
	    IF (#B.Status =  "STS_STARTING") OR (#B.Status =  "STS_RUNNING") THEN
	        #N.DO_Run := TRUE;
	    ELSE
	        #N.DO_Run := FALSE;
	    END_IF;
	END_REGION

END_FUNCTION
