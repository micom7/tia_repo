# Design Rules — SCADA ↔ PLC Route Control (Canon)
**Версія:** 1.0 (зафіксовано в чаті, 2026-01-09)  
**Контекст:** Contract v2.0.0-system-contract fileciteturn0file0

> Мета документа — зафіксувати “залізобетонні” правила архітектури, щоб код і SCADA-логіка залишались детермінованими, тестованими та без двозначностей.

---

## DR-01. Розподіл відповідальності
- **SCADA** відповідає за *процеси* (що/навіщо/коли), сценарії, UX, підтвердження, журналювання.
- **PLC** відповідає за *детерміноване виконання*, арбітраж (Owner), маршрути (Route FSM), safety, діагностику.
- PLC **не містить процесної логіки** і не “оптимізує” технологію.

**Наслідок:** будь-яка “розумна” послідовність — у SCADA; у PLC — лише правила “можна/не можна/виконую”.

---

## DR-02. Route FSM без PAUSE
- У Route FSM **немає** станів `PAUSE/RESUME`.
- Якщо маршрут зупинено, то відновлення завжди відбувається через **повний алгоритм START**.
- “Пауза” на рівні маршруту не додає цінності і лише ускладнює крайові випадки.

**Наслідок:** будь-яка зупинка маршруту трактуєтсья як **ABORT** (оператор/локальний/аварія), а повторний `START` — **новий запуск**.

---

## DR-03. ABORT = “все вільно”
Після будь-якого `ABORTED_*`:
- **усі механізми вільні** (Owner звільняється),
- маршрут повертається в **початкову готовність** до нового START,
- `ResultCode` зберігається для журналу, доки не прийде новий START.

**Наслідок:** відсутні “підвішені” ownership та deadlock-сценарії.

---

## DR-04. Fault завжди аварія
- У системі **немає** “некритичних fault”.
- `FLTCode ≠ 0` → це **аварія**, і вона приводить до **ABORT маршруту**.
- Діагностичні/попереджувальні стани мають бути окремими від `FLTCode` (наприклад warnings), але не змішуються з fault.

---

## DR-05. VALIDATING гарантує готовність до пуску
Перед пуском маршруту PLC виконує повний pre-check (`VALIDATING`):
- валідність структури (slot існує, формат/типи коректні),
- відсутність ownership-конфлікту (усі slot мають `OwnerCur=NONE`),
- готовність механізмів (Enable_OK=1, LocalManual=0),
- готовність HAL/Safety interlocks (усі необхідні умови “OK”),
- відсутність `FLTCode`.

Якщо будь-що не виконано → **REJECT**, без lock/side-effects.

---

## DR-06. REJECT ≠ ABORT (чітка межа)
- **REJECT**: маршрут *не почався* (без команд), **без side-effects**, без lock.
- **ABORT**: маршрут *почався* (були команди/власність), потрібен STOP, і далі фінальний стан `ABORTED_*`.

---

## DR-07. Ownership: атомарність і простота
- Locking owner відбувається **атомарно** для всіх slot маршруту.
- Будь-який конфлікт → **REJECT_BY_OWNER** (не частковий lock).
- При `ABORTED_*` owner звільняється **одразу**.

---

## DR-08. Два типи STOP
Є два незалежних механізми STOP:

### DR-08a. Safety STOP (жорсткий)
Джерела:
- апаратна кнопка на вхід PLC,
- кнопка *Safety Stop* у SCADA.

В PLC формується `GlobalSafetyStop = HW_ESTOP OR SCADA_ESTOP`.

Дія:
- **негайний STOP усього** (глобально),
- маршрут → `ABORTED_BY_SAFETY`,
- owner звільняється **одразу**.

### DR-08b. Operator STOP (контрольований)
Джерело:
- кнопка *Stop* у SCADA (для конкретного маршруту).

Дія:
- **контрольований STOP** механізмів маршруту,
- маршрут → `ABORTED_BY_OPERATOR`,
- owner звільняється після `E_ALL_STOPPED` (або одразу, якщо вже зупинено).

---

## DR-09. Правила START
- `START` при активному `GlobalSafetyStop=1` → **REJECT_BY_SAFETY**.
- Дубль `START` того ж `RouteId` → **REJECT_DUPLICATE_START**.
- `START`, коли маршрут ще не завершився (стан не фінальний)  → **REJECT_DUPLICATE_START**.
- `START` після `ABORTED_*` → дозволений як **новий запуск** (через `VALIDATING → LOCKING → STARTING`).

---

## DR-10. ResultCode — джерело істини + журнал
- `ResultCode` встановлюється у фінальних станах (`DONE/REJECTED/ABORTED`).
- `ResultCode` **не очищається**, доки не прийде новий `START` для цього `RouteId`.
- SCADA використовує `State + ResultCode` для UI та **журналювання**; не робить “розумних” припущень.

---

## DR-11. Єдине місце запису Cmd — арбітр
- Команди в механізм (`Cmd`) задаються **лише через арбітраж**.
- Route Supervisor формує запити, але **не пише Cmd напряму**.

Це відповідає контракту: “єдине місце запису Cmd”. fileciteturn0file0

---

## DR-12. Мінімум даних для прозорості (для кожного RouteId)
PLC має віддавати в SCADA мінімальний набір:
- `State` (enum),
- `ResultCode` (enum),
- `Active` (похідне `State ∈ {VALIDATING..STOPPING}`),
- (опційно) `LastTransitionTick/Time`,
- (опційно) snapshot owner/slot для діагностики.

---

### Додаток: Канонічні стани Route FSM
`IDLE → VALIDATING → LOCKING → STARTING → RUNNING → STOPPING → (DONE|ABORTED)`  
Фінальні: `DONE`, `REJECTED`, `ABORTED` (підпричина в `ResultCode`).

